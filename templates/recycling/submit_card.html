{% extends 'recycling/base.html' %}

{% block title %}提交卡券 - 卡券回收平台{% endblock %}

{% block content %}
<!-- 系统通知模态框 -->
{% if notifications %}
    {% for notification in notifications %}
    <div class="modal fade" id="notificationModal{{ forloop.counter }}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-bell me-2"></i>{{ notification.title }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="notification-content">
                        {{ notification.content|safe }}
                    </div>
                </div>
                <div class="modal-footer">
                    {% if forloop.counter < notifications|length %}
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal" data-next-notification="{{ forloop.counter|add:1 }}">
                        <i class="fas fa-chevron-right me-1"></i>下一条
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i>我知道了
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

<style>
/* 移动端APP风格表单样式 */
@media (max-width: 768px) {
    /* 主卡片APP风格 */
    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .card-header {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        color: white;
        padding: 1.25rem 1.5rem;
    }
    
    .card-header h4 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
        text-align: center;
    }
    
    .card-body {
        padding: 1.5rem;
        background: #ffffff;
    }
    
    /* APP风格表单分区 */
    .form-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
    }
    
    .form-section-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .form-section-title i {
        margin-right: 0.5rem;
        color: #007bff;
    }
    
    /* 标签优化 */
    .form-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    /* 输入框APP风格 */
    .form-control, .form-select {
        font-size: 16px;
        min-height: 48px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
        background: white;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        background: white;
    }
    
    .form-text {
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    
    /* APP风格上传区域 */
    .upload-area {
        padding: 2.5rem 1.5rem !important;
        border: 2px dashed #cbd5e0 !important;
        border-radius: 12px !important;
        background: linear-gradient(45deg, #f8fafc, #f1f5f9);
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #007bff !important;
        background: linear-gradient(45deg, #eff6ff, #dbeafe);
    }
    
    .upload-area i {
        font-size: 3rem !important;
        color: #007bff;
        margin-bottom: 0.5rem;
    }
    
    .upload-area p {
        font-size: 1rem;
        font-weight: 500;
        color: #374151;
        margin: 0.75rem 0 0.25rem !important;
    }
    
    .upload-area small {
        color: #6b7280;
        font-size: 0.85rem;
    }
    
    /* 图片预览APP风格 */
    #imagePreview {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        text-align: center;
    }
    
    #imagePreview img {
        max-width: 180px !important;
        max-height: 180px !important;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* 进度条APP风格 */
    #uploadProgress .progress {
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
    }
    
    #uploadProgress .progress-bar {
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 3px;
    }
    
    /* 按钮APP风格 */
    .btn {
        min-height: 48px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        padding: 0.75rem 2rem;
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.25);
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(0, 123, 255, 0.3);
    }
    
    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
        border-radius: 8px;
        min-height: 36px;
        font-size: 14px;
    }
    
    /* 表单分组间距 */
    .mb-3 {
        margin-bottom: 1.25rem !important;
    }
    
    /* 响应式列优化 */
    .row .col-12 {
        margin-bottom: 0.5rem;
    }
}

@media (max-width: 576px) {
    .card {
        margin: 0.75rem;
        border-radius: 16px;
    }
    
    .card-header {
        padding: 1rem 1.25rem;
    }
    
    .card-body {
        padding: 1.25rem;
    }
    
    .form-section {
        padding: 0.875rem 1rem;
        margin-bottom: 1.25rem;
    }
    
    .upload-area {
        padding: 2rem 1rem !important;
    }
    
    .upload-area i {
        font-size: 2.5rem !important;
    }
}

/* APP风格动画效果 */
@media (max-width: 768px) {
    .form-section {
        animation: slideInUp 0.4s ease-out;
    }
    
    .form-section:nth-child(1) { animation-delay: 0.1s; }
    .form-section:nth-child(2) { animation-delay: 0.2s; }
    .form-section:nth-child(3) { animation-delay: 0.3s; }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
}
</style>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus-circle"></i> 提交卡券回收</h4>
            </div>
                <div class="card-body">
                <form method="post" id="submitForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- APP风格表单分区：基本信息 -->
                    <div class="form-section d-md-none">
                        <div class="form-section-title">
                            <i class="fas fa-info-circle"></i>
                            基本信息
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">卡券类别</label>
                            {{ form.category }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.package.id_for_label }}" class="form-label">选择套餐</label>
                            {{ form.package }}
                            <div class="form-text">
                                <span id="commissionInfo" class="text-muted">请先选择类别</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.store.id_for_label }}" class="form-label">适用门店</label>
                            {{ form.store }}
                            <div class="form-text">
                                <span id="storeInfo" class="text-muted">请先选择套餐</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 桌面端：保持原有布局 -->
                    <div class="d-none d-md-block">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.category.id_for_label }}" class="form-label">卡券类别</label>
                                    {{ form.category }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.package.id_for_label }}" class="form-label">选择套餐</label>
                                    {{ form.package }}
                                    <div class="form-text">
                                        <span id="commissionInfoDesktop" class="text-muted">请先选择类别</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.store.id_for_label }}" class="form-label">适用门店</label>
                                    {{ form.store }}
                                    <div class="form-text">
                                        <span id="storeInfoDesktop" class="text-muted">请先选择套餐</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- APP风格表单分区：卡券信息 -->
                    <div class="form-section d-md-none">
                        <div class="form-section-title">
                            <i class="fas fa-credit-card"></i>
                            卡券信息
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.card_number.id_for_label }}" class="form-label">卡号 <small class="text-muted">(可选)</small></label>
                            {{ form.card_number }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.card_secret.id_for_label }}" class="form-label">密码 <small class="text-muted">(可选)</small></label>
                            {{ form.card_secret }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.redemption_code.id_for_label }}" class="form-label">兑换码 <small class="text-muted">(可选)</small></label>
                            {{ form.redemption_code }}
                        </div>
                        <div class="alert alert-info py-2 px-3 mb-0">
                            <small><i class="fas fa-info-circle me-1"></i>卡号密码、兑换码和核销码图片至少需要提供一项</small>
                        </div>
                    </div>
                    
                    <!-- 桌面端：卡券信息 -->
                    <div class="d-none d-md-block">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.card_number.id_for_label }}" class="form-label">卡号 <small class="text-muted">(可选)</small></label>
                                    {{ form.card_number }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.card_secret.id_for_label }}" class="form-label">密码 <small class="text-muted">(可选)</small></label>
                                    {{ form.card_secret }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.redemption_code.id_for_label }}" class="form-label">兑换码 <small class="text-muted">(可选)</small></label>
                                    {{ form.redemption_code }}
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mb-3">
                            <small class="text-info">注意：卡号密码、兑换码和核销码图片至少需要提供一项</small>
                        </div>
                    </div>
                    
                    <!-- APP风格表单分区：图片上传 -->
                    <div class="form-section d-md-none">
                        <div class="form-section-title">
                            <i class="fas fa-image"></i>
                            核销码图片
                        </div>
                        <div class="mb-3">
                            <label for="imageFile" class="form-label">上传图片 <small class="text-muted">(可选)</small></label>
                            {{ form.image }}
                            <input type="file" class="form-control" id="imageFile" accept="image/jpeg,image/png,image/jpg" style="display: none;">
                            <div class="upload-area border rounded p-3 text-center" style="cursor: pointer;">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>点击选择图片或拖拽文件到此处</p>
                                <small>支持JPG、PNG格式，最大10MB</small>
                            </div>
                            <div id="uploadProgress" class="mt-3" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted mt-1 d-block">正在上传...</small>
                            </div>
                            <div id="imagePreview" class="mt-3" style="display: none;">
                                <img id="previewImg" src="" alt="图片预览" class="img-thumbnail">
                                <div class="mt-2">
                                    <small class="text-success d-block mb-2">上传成功</small>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="removeImage">删除图片</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 桌面端：图片上传 -->
                    <div class="d-none d-md-block">
                        <div class="mb-3">
                            <label for="imageFile" class="form-label">核销码图片 <small class="text-muted">(可选)</small></label>
                            {{ form.image }}
                            <input type="file" class="form-control" id="imageFile" accept="image/jpeg,image/png,image/jpg" style="display: none;">
                            <div class="upload-area border rounded p-3 text-center" style="cursor: pointer; border: 2px dashed #ccc;">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted"></i>
                                <p class="mt-2 mb-0">点击选择图片或拖拽文件到此处</p>
                                <small class="text-muted">支持JPG、PNG格式，最大10MB</small>
                            </div>
                            <div id="uploadProgress" class="mt-2" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted">正在上传...</small>
                            </div>
                            <div id="imagePreview" class="mt-2" style="display: none;">
                                <img id="previewImg" src="" alt="图片预览" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                <div class="mt-1">
                                    <small class="text-success">上传成功</small>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="removeImage">删除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- APP风格表单分区：收款码 -->
                    <div class="form-section d-md-none">
                        <div class="form-section-title">
                            <i class="fas fa-qrcode"></i>
                            收款码
                        </div>
                        {% if existing_payment_code %}
                        <div class="alert alert-info py-2 px-3 mb-3">
                            <small><i class="fas fa-info-circle me-1"></i>已自动加载您的收款码，如需更换请重新上传</small>
                        </div>
                        <div id="mobile-existing-payment" class="mb-3">
                            <img src="{{ existing_payment_code }}" alt="收款码" class="img-thumbnail" style="max-height: 100px;">
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="mobile-change-payment">更换收款码</button>
                            </div>
                        </div>
                        {% endif %}
                        <div class="mb-3" id="mobile-payment-upload" {% if existing_payment_code %}style="display: none;"{% endif %}>
                            <label class="form-label">上传收款码</label>
                            <input type="file" class="form-control" id="mobile-payment-code" accept="image/jpeg,image/png,image/jpg" style="display: none;">
                            <input type="hidden" id="mobile-payment-code-url" name="payment_code" value="{{ existing_payment_code|default:'' }}">
                            <div class="upload-area border rounded p-3 text-center" style="cursor: pointer;" id="mobile-payment-upload-area">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>点击上传收款码</p>
                                <small>支持JPG、PNG格式</small>
                            </div>
                            <div id="mobile-payment-preview" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <!-- APP风格表单分区：联系信息 -->
                    <div class="form-section d-md-none">
                        <div class="form-section-title">
                            <i class="fas fa-phone"></i>
                            联系信息
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.expire_date.id_for_label }}" class="form-label">过期时间</label>
                            {{ form.expire_date }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.telephone.id_for_label }}" class="form-label">联系电话</label>
                            {{ form.telephone }}
                        </div>
                    </div>
                    
                    <!-- 桌面端：联系信息 -->
                    <div class="d-none d-md-block">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.expire_date.id_for_label }}" class="form-label">过期时间</label>
                                    {{ form.expire_date }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.telephone.id_for_label }}" class="form-label">联系电话</label>
                                    {{ form.telephone }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>提交卡券
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.staticfile.org/qiniu-js/3.4.1/qiniu.min.js"></script>
<script>
// 确保jQuery已加载
if (typeof $ === 'undefined') {
    console.error('jQuery未加载，请检查静态文件配置');
    alert('页面加载异常，请刷新重试');
}

$(document).ready(function() {
    // 移动端支付码上传功能
    $('#mobile-payment-upload-area').click(function() {
        $('#mobile-payment-code').click();
    });
    
    $('#mobile-payment-code').change(function() {
        const file = this.files[0];
        if (file) {
            uploadToQiniu(file, 'payment_code', function(url) {
                $('#mobile-payment-code-url').val(url);
                $('#mobile-payment-preview').html('<img src="' + url + '" alt="收款码" class="img-thumbnail" style="max-height: 100px;">');
                $('#mobile-existing-payment').hide();
                $('#mobile-payment-upload').show();
            });
        }
    });
    
    // 更换收款码按钮
    $('#mobile-change-payment').click(function() {
        $('#mobile-existing-payment').hide();
        $('#mobile-payment-upload').show();
    });
    
    // 类别选择变化时更新套餐和门店字段可见性
    $('#category').change(function() {
        var categoryId = $(this).val();
        if (categoryId) {
            // 获取类别信息
            $.get('/api/categories/', {category_id: categoryId})
                .done(function(categoryData) {
                    // 控制门店字段显示（移动端和桌面端）
                    var storeFieldMobile = $('#store').closest('.col-12');
                    var storeFieldDesktop = $('#store').closest('.col-md-4');
                    if (categoryData.show_store_field) {
                        storeFieldMobile.show();
                        storeFieldDesktop.show();
                    } else {
                        storeFieldMobile.hide();
                        storeFieldDesktop.hide();
                        $('#store').val(''); // 清空门店选择
                    }
                })
                .fail(function() {
                    console.error('获取类别信息失败');
                });
            
            // 加载套餐
            $.get('/api/packages/', {category_id: categoryId})
                .done(function(data) {
                    var packageSelect = $('#package');
                    packageSelect.empty();
                    packageSelect.append('<option value="">请选择套餐</option>');
                    
                    $.each(data, function(index, package) {
                        packageSelect.append('<option value="' + package.id + '">' + package.name + '</option>');
                    });
                })
                .fail(function() {
                    console.error('获取套餐列表失败');
                });
        } else {
            $('#package').empty().append('<option value="">请先选择类别</option>');
            $('#commissionInfo, #commissionInfoDesktop').text('请先选择类别');
            // 显示门店字段（默认显示）
            $('#store').closest('.col-12, .col-md-4').show();
        }
    });
    
    // 套餐选择变化时显示佣金和加载门店
    $('#package').change(function() {
        var packageId = $(this).val();
        if (packageId) {
            var categoryId = $('#category').val();
            // 获取套餐信息和佣金
            $.get('/api/packages/', {category_id: categoryId})
                .done(function(data) {
                    var selectedPackage = data.find(function(p) { return p.id == packageId; });
                    if (selectedPackage) {
                        $('#commissionInfo, #commissionInfoDesktop').text('佣金：￥' + selectedPackage.commission);
                    }
                })
                .fail(function() {
                    $('#commissionInfo, #commissionInfoDesktop').text('获取佣金信息失败');
                });
            
            // 加载适用门店
            $.get('/api/stores/', {package_id: packageId})
                .done(function(data) {
                    var storeSelect = $('#store');
                    storeSelect.empty();
                    storeSelect.append('<option value="">请选择门店</option>');
                    
                    $.each(data, function(index, store) {
                        storeSelect.append('<option value="' + store.id + '">' + store.name + '</option>');
                    });
                    
                    if (data.length === 0) {
                        $('#storeInfo, #storeInfoDesktop').text('该套餐暂无可用门店');
                    } else {
                        $('#storeInfo, #storeInfoDesktop').text('共' + data.length + '个门店可选');
                    }
                })
                .fail(function() {
                    $('#storeInfo, #storeInfoDesktop').text('获取门店列表失败');
                });
        } else {
            $('#commissionInfo, #commissionInfoDesktop').text('请先选择套餐');
            $('#store').empty().append('<option value="">请先选择套餐</option>');
            $('#storeInfo, #storeInfoDesktop').text('请先选择套餐');
        }
    });
    
    // 门店选择变化时显示门店信息
    $('#store').change(function() {
        var storeId = $(this).val();
        if (storeId) {
            var selectedText = $(this).find('option:selected').text();
            $('#storeInfo, #storeInfoDesktop').text('已选择：' + selectedText);
        } else {
            $('#storeInfo, #storeInfoDesktop').text('请选择门店');
        }
    });
    
    // 图片上传功能
    var uploadedImageUrl = '';
    
    // 点击上传区域
    $('.upload-area').click(function() {
        $('#imageFile').click();
    });
    
    // 文件选择处理
    $('#imageFile').change(function() {
        var file = this.files[0];
        if (file) {
            uploadToQiniu(file);
        }
    });
    
    // 拖拽上传
    $('.upload-area').on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('border-primary');
    });
    
    $('.upload-area').on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('border-primary');
    });
    
    $('.upload-area').on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('border-primary');
        var files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            uploadToQiniu(files[0]);
        }
    });
    
    // 删除图片
    $('#removeImage').click(function() {
        uploadedImageUrl = '';
        $('#id_image').val('');
        $('#imagePreview').hide();
        $('.upload-area').show();
        $('#imageFile').val('');
    });
    
    // 上传到七牛云
    function uploadToQiniu(file) {
        // 验证文件
        if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
            alert('请选择JPG或PNG格式的图片');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('图片大小不能超过10MB');
            return;
        }
        
        // 显示上传进度
        $('.upload-area').hide();
        $('#uploadProgress').show();
        var progressBar = $('#uploadProgress .progress-bar');
        
        // 获取上传token
        $.get('/api/qiniu-token/')
            .done(function(data) {
                if (data.token) {
                    // 生成唯一文件名
                    var filename = 'card_recycle/' + generateUUID() + '.' + file.name.split('.').pop();
                    
                    // 配置七牛云上传
                    var config = {
                        useCdnDomain: true,
                        region: qiniu.region.z0  // 华东区域
                    };
                    
                    var putExtra = {
                        fname: filename,
                        params: {},
                        mimeType: ["image/png", "image/jpeg", "image/jpg"]
                    };
                    
                    // 创建上传任务
                    var observable = qiniu.upload(file, filename, data.token, putExtra, config);
                    
                    // 监听上传进度
                    var subscription = observable.subscribe({
                        next: function(res) {
                            var percent = Math.floor(res.total.percent);
                            progressBar.css('width', percent + '%');
                        },
                        error: function(err) {
                            console.error('上传失败:', err);
                            alert('图片上传失败，请重试');
                            resetUploadArea();
                        },
                        complete: function(res) {
                            // 上传成功
                            uploadedImageUrl = 'https://guangpan.lingjing235.cn/' + res.key;
                            $('#id_image').val(uploadedImageUrl);
                            
                            // 显示预览
                            $('#previewImg').attr('src', uploadedImageUrl);
                            $('#uploadProgress').hide();
                            $('#imagePreview').show();
                        }
                    });
                } else {
                    alert('获取上传凭证失败');
                    resetUploadArea();
                }
            })
            .fail(function() {
                alert('获取上传凭证失败');
                resetUploadArea();
            });
    }
    
    // 重置上传区域
    function resetUploadArea() {
        $('#uploadProgress').hide();
        $('.upload-area').show();
        $('#uploadProgress .progress-bar').css('width', '0%');
    }
    
    // 生成UUID
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    
    // 表单提交验证
    $('#submitForm').submit(function(e) {
        // 验证必填字段
        if (!$('#category').val()) {
            alert('请选择卡券类别');
            e.preventDefault();
            return false;
        }
        
        if (!$('#package').val()) {
            alert('请选择套餐');
            e.preventDefault();
            return false;
        }
        
        if (!$('#store').val()) {
            alert('请选择适用门店');
            e.preventDefault();
            return false;
        }
        
        if (!$('#id_expire_date').val()) {
            alert('请选择过期时间');
            e.preventDefault();
            return false;
        }
        
        if (!$('#id_telephone').val().trim()) {
            alert('请输入联系电话');
            e.preventDefault();
            return false;
        }
        
        // 验证收款码（移动端必须）
        if (window.innerWidth <= 768 && !$('#mobile-payment-code-url').val()) {
            alert('请上传收款码');
            e.preventDefault();
            return false;
        }
        
        // 验证卡号密码、兑换码和图片至少一项
        var hasCardInfo = $('#id_card_number').val().trim() || $('#id_card_secret').val().trim();
        var hasRedemptionCode = $('#id_redemption_code').val().trim();
        var hasImage = uploadedImageUrl || $('#id_image').val();
        
        if (!hasCardInfo && !hasRedemptionCode && !hasImage) {
            alert('请至少填写卡号密码、兑换码或上传核销码图片');
            e.preventDefault();
            return false;
        }
        
        // 移动端使用AJAX提交
        if (window.innerWidth <= 768) {
            e.preventDefault();
            
            const formData = {
                category: $('#category').val(),
                package: $('#package').val(),
                store: $('#store').val(),
                card_number: $('#id_card_number').val(),
                card_secret: $('#id_card_secret').val(),
                redemption_code: $('#id_redemption_code').val(),
                image: $('#id_image').val(),
                expire_date: $('#id_expire_date').val(),
                telephone: $('#id_telephone').val(),
                payment_code: $('#mobile-payment-code-url').val(),
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            };
            
            // 显示提交按钮加载状态
            var submitBtn = $('.btn-primary');
            var originalText = submitBtn.html();
            submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>提交中...').prop('disabled', true);
            
            $.ajax({
                url: '{% url "submit_card" %}',
                type: 'POST',
                data: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.success) {
                        alert('提交成功！');
                        window.location.href = '{% url "my_submissions" %}';
                    } else {
                        alert('提交失败：' + (response.error || '未知错误'));
                        submitBtn.html(originalText).prop('disabled', false);
                    }
                },
                error: function() {
                    alert('网络错误，请稍后重试');
                    submitBtn.html(originalText).prop('disabled', false);
                }
            });
            
            return false;
        }
    });
    
    // 显示系统通知
    {% if notifications %}
    var currentNotification = 1;
    var totalNotifications = {{ notifications|length }};
    
    function showNotification(notificationNum) {
        if ($('#notificationModal' + notificationNum).length > 0) {
            console.log('显示通知弹窗 ' + notificationNum);
            $('#notificationModal' + notificationNum).modal('show');
        }
    }
    
    // 处理"下一条"按钮
    $('[data-next-notification]').click(function() {
        var nextNum = $(this).data('next-notification');
        setTimeout(function() {
            showNotification(nextNum);
        }, 300);
    });
    
    // 页面加载完成后显示第一个通知
    $(document).ready(function() {
        setTimeout(function() {
            showNotification(1);
        }, 500);
    });
    
    // 移动端兜底显示
    setTimeout(function() {
        if (!$('#notificationModal1').hasClass('show')) {
            console.log('兜底显示第一个通知');
            showNotification(1);
        }
    }, 2000);
    {% endif %}
});
</script>

{% if notifications %}
<style>
.notification-content {
    line-height: 1.6;
}
.notification-content p {
    margin-bottom: 1rem;
}
.notification-content ul, .notification-content ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

/* 移动端通知弹窗优化 */
@media (max-width: 768px) {
    [id^="notificationModal"] .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
    }
    
    [id^="notificationModal"] .modal-content {
        border-radius: 8px;
    }
    
    [id^="notificationModal"] .modal-body {
        padding: 20px;
        max-height: 70vh;
        overflow-y: auto;
    }
    
    /* 确保在移动端能正常显示 */
    [id^="notificationModal"] {
        padding-right: 0 !important;
    }
    
    [id^="notificationModal"] .modal-backdrop {
        position: fixed;
    }
}
</style>
{% endif %}
{% endblock %}