{% extends 'recycling/admin_base.html' %}

{% block title %}{% if tutorial %}编辑教程{% else %}新增教程{% endif %}{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_tutorials' %}">教程管理</a></li>
<li class="breadcrumb-item active">{% if tutorial %}编辑教程{% else %}新增教程{% endif %}</li>
{% endblock %}

{% block extra_css %}
<style>
.cover-image-preview {
    max-width: 200px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 8px;
}

.markdown-import-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s;
}

.markdown-import-area:hover {
    border-color: #007bff;
    background: #e3f2fd;
}

.markdown-import-area.dragover {
    border-color: #28a745;
    background: #d4edda;
}

.editor-toolbar {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.content-editor {
    border: 1px solid #dee2e6;
    border-top: none;
    min-height: 500px;
}

#contentTextarea {
    border: none;
    resize: vertical;
    font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    padding: 12px 16px;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.notification.show {
    transform: translateX(0);
}

.notification.success { background-color: #28a745; }
.notification.error { background-color: #dc3545; }
.notification.warning { background-color: #ffc107; color: #212529; }
.notification.info { background-color: #17a2b8; }
</style>
{% endblock %}

{% block content %}
<div class="p-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="post" id="tutorialForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- 左侧主要信息 -->
                            <div class="col-lg-8">
                                <!-- 标题 -->
                                <div class="mb-3">
                                    <label for="title" class="form-label fw-bold">教程标题 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{% if tutorial %}{{ tutorial.title }}{% endif %}" 
                                           placeholder="请输入教程标题" required>
                                </div>
                                
                                <!-- 摘要 -->
                                <div class="mb-3">
                                    <label for="summary" class="form-label fw-bold">教程摘要 <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="summary" name="summary" rows="3" 
                                              placeholder="请输入教程摘要，建议100-300字" required>{% if tutorial %}{{ tutorial.summary }}{% endif %}</textarea>
                                    <div class="form-text">
                                        <span id="summaryCount">{% if tutorial %}{{ tutorial.summary|length }}{% else %}0{% endif %}</span>/300 字
                                    </div>
                                </div>
                                
                                <!-- Markdown 文档导入 -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Markdown 文档导入</label>
                                    <div class="markdown-import-area" id="markdownImport">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="mb-2">点击选择或拖拽 .md 文件到此处</p>
                                        <small class="text-muted">支持拖拽上传，自动解析 Markdown 格式</small>
                                        <input type="file" id="markdownFile" accept=".md,.markdown,.txt" style="display: none;">
                                    </div>
                                </div>
                                
                                <!-- 教程内容编辑器 -->
                                <div class="mb-4">
                                    <label for="content" class="form-label fw-bold">教程内容 <span class="text-danger">*</span></label>
                                    
                                    <!-- 编辑器工具栏 -->
                                    <div class="editor-toolbar">
                                        <div class="btn-group me-3" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('basic')">
                                                <i class="fas fa-file-alt"></i> 基础模板
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('steps')">
                                                <i class="fas fa-list-ol"></i> 步骤模板
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('faq')">
                                                <i class="fas fa-question-circle"></i> 问答模板
                                            </button>
                                        </div>
                                        <div class="ms-auto">
                                            <small class="text-muted">支持 Markdown 语法</small>
                                        </div>
                                    </div>
                                    
                                    <!-- 内容编辑器 -->
                                    <div class="content-editor">
                                        <textarea class="form-control" name="content" id="contentTextarea" 
                                                  rows="25" placeholder="请输入教程内容，支持 Markdown 语法...">{% if tutorial %}{{ tutorial.content }}{% endif %}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧辅助信息 -->
                            <div class="col-lg-4">
                                <!-- 发布设置 -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-cog me-2"></i>发布设置</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- 类别 -->
                                        <div class="mb-3">
                                            <label for="category" class="form-label fw-bold">所属类别 <span class="text-danger">*</span></label>
                                            <select class="form-control" id="category" name="category" required>
                                                <option value="">请选择类别</option>
                                                {% for category in categories %}
                                                <option value="{{ category.id }}" 
                                                        {% if tutorial and tutorial.category.id == category.id %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <!-- 状态 -->
                                        <div class="mb-3">
                                            <label for="status" class="form-label fw-bold">状态</label>
                                            <select class="form-control" id="status" name="status">
                                                <option value="draft" {% if not tutorial or tutorial.status == 'draft' %}selected{% endif %}>草稿</option>
                                                <option value="published" {% if tutorial and tutorial.status == 'published' %}selected{% endif %}>发布</option>
                                                <option value="archived" {% if tutorial and tutorial.status == 'archived' %}selected{% endif %}>归档</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 推荐 -->
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured" 
                                                       {% if tutorial and tutorial.is_featured %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="is_featured">
                                                    <i class="fas fa-star text-warning me-1"></i>设为推荐
                                                </label>
                                                <div class="form-text">推荐教程会在首页显示</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 封面图片 -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-image me-2"></i>封面图片</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <input type="url" class="form-control" id="cover_image" name="cover_image" 
                                                   value="{% if tutorial %}{{ tutorial.cover_image }}{% endif %}" 
                                                   placeholder="输入图片URL">
                                        </div>
                                        <div id="coverPreview" class="text-center" {% if not tutorial or not tutorial.cover_image %}style="display: none;"{% endif %}>
                                            {% if tutorial and tutorial.cover_image %}
                                            <img src="{{ tutorial.cover_image }}" alt="封面预览" class="cover-image-preview">
                                            {% else %}
                                            <img alt="封面预览" class="cover-image-preview">
                                            {% endif %}
                                        </div>
                                        <small class="form-text text-muted">建议尺寸: 400x300 像素</small>
                                    </div>
                                </div>
                                
                                <!-- 教程统计 -->
                                {% if tutorial %}
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>教程统计</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <div class="h5 text-primary mb-1">{{ tutorial.views }}</div>
                                                    <small class="text-muted">浏览次数</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="h5 text-success mb-1">{{ tutorial.created_at|timesince }}</div>
                                                <small class="text-muted">创建时间</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'admin_tutorials' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> 返回
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                                    <i class="fas fa-save"></i> 保存草稿
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check"></i> {% if tutorial %}更新教程{% else %}创建教程{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let isInitialized = false;

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    if (isInitialized) return;
    isInitialized = true;
    
    // 初始化所有功能
    initSummaryCounter();
    initCoverPreview();
    initMarkdownImport();
    
    console.log('教程编辑页面初始化完成');
});

// 通知函数
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // 显示动画
    setTimeout(() => notification.classList.add('show'), 100);
    
    // 自动隐藏
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// 摘要字数统计
function initSummaryCounter() {
    const summaryInput = document.getElementById('summary');
    const summaryCount = document.getElementById('summaryCount');
    
    if (!summaryInput || !summaryCount) return;
    
    summaryInput.addEventListener('input', function() {
        const length = this.value.length;
        summaryCount.textContent = length;
        
        if (length > 300) {
            summaryCount.className = 'text-danger';
        } else {
            summaryCount.className = '';
        }
    });
}

// 封面图片预览
function initCoverPreview() {
    const coverInput = document.getElementById('cover_image');
    const coverPreview = document.getElementById('coverPreview');
    const coverImg = coverPreview.querySelector('img');
    
    if (!coverInput || !coverPreview || !coverImg) return;
    
    coverInput.addEventListener('input', function() {
        const url = this.value.trim();
        if (url) {
            coverImg.src = url;
            coverPreview.style.display = 'block';
            
            // 检查图片是否能正常加载
            coverImg.onload = function() {
                showNotification('封面图片预览更新成功', 'success');
            };
            
            coverImg.onerror = function() {
                showNotification('图片链接无效或无法访问', 'warning');
            };
        } else {
            coverPreview.style.display = 'none';
        }
    });
}

// Markdown文件导入
function initMarkdownImport() {
    const importArea = document.getElementById('markdownImport');
    const fileInput = document.getElementById('markdownFile');
    
    if (!importArea || !fileInput) return;
    
    // 点击上传
    importArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    // 文件选择
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            readMarkdownFile(file);
        }
    });
    
    // 拖拽上传
    importArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    importArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });
    
    importArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            readMarkdownFile(files[0]);
        }
    });
}

// 读取Markdown文件
function readMarkdownFile(file) {
    if (!file.name.match(/\.(md|markdown|txt)$/i)) {
        showNotification('请选择 .md、.markdown 或 .txt 文件', 'warning');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            const lines = content.split('\n');
            
            let title = '';
            let summary = '';
            let bodyContent = content;
            
            // 查找第一个 # 标题
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('# ')) {
                    title = line.substring(2).trim();
                    lines.splice(i, 1);
                    bodyContent = lines.join('\n');
                    break;
                }
            }
            
            // 生成摘要
            const plainText = bodyContent.replace(/[#*`\[\]]/g, '').trim();
            summary = plainText.substring(0, 200) + (plainText.length > 200 ? '...' : '');
            
            // 填充表单
            if (title) {
                const titleInput = document.getElementById('title');
                if (titleInput) titleInput.value = title;
            }
            
            if (summary) {
                const summaryInput = document.getElementById('summary');
                if (summaryInput) {
                    summaryInput.value = summary;
                    // 触发字数统计更新
                    summaryInput.dispatchEvent(new Event('input'));
                }
            }
            
            // 设置内容
            const contentTextarea = document.getElementById('contentTextarea');
            if (contentTextarea) {
                contentTextarea.value = bodyContent;
            }
            
            showNotification('Markdown 文件导入成功', 'success');
            
        } catch (error) {
            console.error('文件读取失败:', error);
            showNotification('文件导入失败，请检查文件格式', 'error');
        }
    };
    
    reader.onerror = function() {
        showNotification('文件读取失败', 'error');
    };
    
    reader.readAsText(file, 'UTF-8');
}

// 插入模板
function insertTemplate(type) {
    const contentTextarea = document.getElementById('contentTextarea');
    if (!contentTextarea) return;
    
    const currentContent = contentTextarea.value.trim();
    if (currentContent !== '') {
        if (!confirm('当前编辑器有内容，确定要替换为模板内容吗？')) {
            return;
        }
    }
    
    let template = '';
    
    switch(type) {
        case 'basic':
            template = `# 教程标题

## 简介

在这里介绍本教程的目标和适用场景。

## 前提条件

- 条件1
- 条件2
- 条件3

## 主要内容

### 第一部分

详细介绍第一部分内容...

### 第二部分

详细介绍第二部分内容...

## 总结

总结本教程的要点...

## 延伸阅读

- [相关链接1](https://example.com)
- [相关链接2](https://example.com)
`;
            break;
            
        case 'steps':
            template = `# 操作教程

## 概述

本教程将指导您完成...

## 步骤详解

### 步骤1：准备工作

1. 首先...
2. 然后...
3. 接下来...

> **注意：** 重要提示信息

### 步骤2：核心操作

1. 打开...
2. 点击...
3. 输入...

\`\`\`bash
# 示例代码
command example
\`\`\`

### 步骤3：验证结果

1. 检查...
2. 确认...

## 常见问题

**Q: 如果遇到错误怎么办？**
A: 请检查...

**Q: 为什么没有效果？**
A: 可能的原因是...

## 完成

恭喜！您已经成功完成了...
`;
            break;
            
        case 'faq':
            template = `# 常见问题解答

## 基础问题

### Q1: 这是什么？
**A:** 详细回答...

### Q2: 如何使用？
**A:** 使用方法如下：
1. 第一步
2. 第二步
3. 第三步

## 高级问题

### Q3: 如何解决复杂问题？
**A:** 解决方案：

- 方案1：...
- 方案2：...
- 方案3：...

### Q4: 有什么注意事项？
**A:** 需要注意：

> ⚠️ **重要提醒：** 在操作前请务必...

## 技术问题

### Q5: 如何排查错误？
**A:** 排查步骤：

\`\`\`
错误信息示例
\`\`\`

解决方法：...

## 联系支持

如果以上解答不能解决您的问题，请...
`;
            break;
    }
    
    contentTextarea.value = template;
    showNotification(`${type === 'basic' ? '基础' : type === 'steps' ? '步骤' : '问答'}模板已插入`, 'success');
}

// 保存草稿
function saveDraft() {
    const statusSelect = document.getElementById('status');
    if (statusSelect) {
        statusSelect.value = 'draft';
    }
    document.getElementById('tutorialForm').submit();
}
</script>
{% endblock %}