{% extends 'recycling/admin_base.html' %}

{% block title %}{% if tutorial %}编辑教程{% else %}新增教程{% endif %}{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_tutorials' %}">教程管理</a></li>
<li class="breadcrumb-item active">{% if tutorial %}编辑教程{% else %}新增教程{% endif %}</li>
{% endblock %}

{% block extra_css %}
<!-- Editor.md CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/css/editormd.min.css" />
<!-- TinyMCE (Rich Text Editor) -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<!-- Quill Rich Text Editor (backup) -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<style>
.cover-image-preview {
    max-width: 200px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 8px;
}

.markdown-import-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s;
}

.markdown-import-area:hover {
    border-color: #007bff;
    background: #e3f2fd;
}

.markdown-import-area.dragover {
    border-color: #28a745;
    background: #d4edda;
}

.editor-toolbar {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0.5rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.template-card {
    cursor: pointer;
    transition: all 0.3s;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="p-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="post" id="tutorialForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- 左侧主要信息 -->
                            <div class="col-lg-8">
                                <!-- 标题 -->
                                <div class="mb-3">
                                    <label for="title" class="form-label fw-bold">教程标题 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{% if tutorial %}{{ tutorial.title }}{% endif %}" 
                                           placeholder="请输入教程标题" required>
                                </div>
                                
                                <!-- 摘要 -->
                                <div class="mb-3">
                                    <label for="summary" class="form-label fw-bold">教程摘要 <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="summary" name="summary" rows="3" 
                                              placeholder="请输入教程摘要，建议100-300字" required>{% if tutorial %}{{ tutorial.summary }}{% endif %}</textarea>
                                    <div class="form-text">
                                        <span id="summaryCount">{% if tutorial %}{{ tutorial.summary|length }}{% else %}0{% endif %}</span>/300 字
                                    </div>
                                </div>
                                
                                <!-- Markdown 文档导入 -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Markdown 文档导入</label>
                                    <div class="markdown-import-area" id="markdownImport">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="mb-2">点击选择或拖拽 .md 文件到此处</p>
                                        <small class="text-muted">支持拖拽上传，自动解析 Markdown 格式</small>
                                        <input type="file" id="markdownFile" accept=".md,.markdown,.txt" style="display: none;">
                                    </div>
                                </div>
                                
                                <!-- 教程内容编辑器 -->
                                <div class="mb-4">
                                    <label for="content" class="form-label fw-bold">教程内容 <span class="text-danger">*</span></label>
                                    
                                    <!-- 编辑器工具栏 -->
                                    <div class="editor-toolbar">
                                        <div class="btn-group me-3" role="group">
                                            <input type="radio" class="btn-check" name="editorMode" id="markdownMode" value="markdown" checked>
                                            <label class="btn btn-sm btn-outline-primary" for="markdownMode">
                                                <i class="fab fa-markdown"></i> Markdown
                                            </label>
                                            <input type="radio" class="btn-check" name="editorMode" id="richTextMode" value="richtext">
                                            <label class="btn btn-sm btn-outline-primary" for="richTextMode">
                                                <i class="fas fa-edit"></i> 富文本
                                            </label>
                                        </div>
                                        
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('basic')">
                                            <i class="fas fa-file-alt"></i> 基础模板
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('steps')">
                                            <i class="fas fa-list-ol"></i> 步骤模板
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('faq')">
                                            <i class="fas fa-question-circle"></i> 问答模板
                                        </button>
                                        <div class="ms-auto">
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="togglePreview()">
                                                <i class="fas fa-eye"></i> 预览
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Markdown 编辑器 -->
                                    <div id="editormd" class="editor-container">
                                        <textarea style="display:none;" name="content" id="markdownContent">{% if tutorial %}{{ tutorial.content }}{% endif %}</textarea>
                                    </div>
                                    
                                    <!-- 富文本编辑器 -->
                                    <div id="richtextEditor" class="editor-container" style="display: none;">
                                        <div id="quillEditor" style="height: 600px;"></div>
                                        <textarea name="richtext_content" id="richtextContent" style="display: none;">{% if tutorial %}{{ tutorial.content }}{% endif %}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧辅助信息 -->
                            <div class="col-lg-4">
                                <!-- 发布设置 -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-cog me-2"></i>发布设置</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- 类别 -->
                                        <div class="mb-3">
                                            <label for="category" class="form-label fw-bold">所属类别 <span class="text-danger">*</span></label>
                                            <select class="form-control" id="category" name="category" required>
                                                <option value="">请选择类别</option>
                                                {% for category in categories %}
                                                <option value="{{ category.id }}" 
                                                        {% if tutorial and tutorial.category.id == category.id %}selected{% endif %}>
                                                    {{ category.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <!-- 状态 -->
                                        <div class="mb-3">
                                            <label for="status" class="form-label fw-bold">状态</label>
                                            <select class="form-control" id="status" name="status">
                                                <option value="draft" {% if not tutorial or tutorial.status == 'draft' %}selected{% endif %}>草稿</option>
                                                <option value="published" {% if tutorial and tutorial.status == 'published' %}selected{% endif %}>发布</option>
                                                <option value="archived" {% if tutorial and tutorial.status == 'archived' %}selected{% endif %}>归档</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 推荐 -->
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured" 
                                                       {% if tutorial and tutorial.is_featured %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="is_featured">
                                                    <i class="fas fa-star text-warning me-1"></i>设为推荐
                                                </label>
                                                <div class="form-text">推荐教程会在首页显示</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 封面图片 -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-image me-2"></i>封面图片</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <input type="url" class="form-control" id="cover_image" name="cover_image" 
                                                   value="{% if tutorial %}{{ tutorial.cover_image }}{% endif %}" 
                                                   placeholder="输入图片URL">
                                        </div>
                                        {% if tutorial and tutorial.cover_image %}
                                        <div class="text-center">
                                            <img id="coverPreview" src="{{ tutorial.cover_image }}" alt="封面预览" class="cover-image-preview">
                                        </div>
                                        {% else %}
                                        <div id="coverPreview" class="text-center text-muted" style="display: none;">
                                            <img alt="封面预览" class="cover-image-preview">
                                        </div>
                                        {% endif %}
                                        <small class="form-text text-muted">建议尺寸: 400x300 像素</small>
                                    </div>
                                </div>
                                
                                <!-- 教程统计 -->
                                {% if tutorial %}
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>教程统计</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <div class="h5 text-primary mb-1">{{ tutorial.views }}</div>
                                                    <small class="text-muted">浏览次数</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="h5 text-success mb-1">{{ tutorial.created_at|timesince }}</div>
                                                <small class="text-muted">创建时间</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'admin_tutorials' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> 返回
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                                    <i class="fas fa-save"></i> 保存草稿
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check"></i> {% if tutorial %}更新教程{% else %}创建教程{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 模板选择模态框 -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">选择教程模板</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card template-card" onclick="useTemplate('basic')">
                            <div class="card-body text-center">
                                <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                                <h6>基础模板</h6>
                                <small class="text-muted">包含标题、介绍、内容结构</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card template-card" onclick="useTemplate('steps')">
                            <div class="card-body text-center">
                                <i class="fas fa-list-ol fa-2x text-success mb-2"></i>
                                <h6>步骤模板</h6>
                                <small class="text-muted">适合操作教程，包含详细步骤</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card template-card" onclick="useTemplate('faq')">
                            <div class="card-body text-center">
                                <i class="fas fa-question-circle fa-2x text-warning mb-2"></i>
                                <h6>问答模板</h6>
                                <small class="text-muted">常见问题解答格式</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Editor.md JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/editormd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/lib/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/lib/prettify.min.js"></script>
<script>
let editor;
let quillEditor;
let isPreviewMode = false;
let currentEditorMode = 'markdown';

// 确保jQuery加载完成后再初始化
function initializePage() {
    // 检查jQuery是否可用
    if (typeof $ === 'undefined') {
        console.error('jQuery未加载，延迟初始化');
        setTimeout(initializePage, 500);
        return;
    }
    
    $(document).ready(function() {
        // 初始化编辑器
        initEditors();
        
        // 编辑器模式切换
        $('input[name="editorMode"]').on('change', function() {
            switchEditorMode($(this).val());
        });
        
        // 摘要字数统计
        $('#summary').on('input', function() {
            const length = $(this).val().length;
            $('#summaryCount').text(length);
            if (length > 300) {
                $('#summaryCount').addClass('text-danger');
            } else {
                $('#summaryCount').removeClass('text-danger');
            }
        });
        
        // 封面图片预览
        $('#cover_image').on('input', function() {
            const url = $(this).val();
            if (url) {
                $('#coverPreview img').attr('src', url);
                $('#coverPreview').show();
            } else {
                $('#coverPreview').hide();
            }
        });
        
        // Markdown 文件导入
        setupMarkdownImport();
        
        // 表单提交处理
        $('#tutorialForm').on('submit', function() {
            syncEditorContent();
        });
    });
}

// 启动初始化
initializePage();

// 通用通知函数
function showNotification(message, type = 'info') {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // 添加到页面
    document.body.appendChild(notification);
    
    // 3秒后自动消失
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// 初始化所有编辑器
function initEditors() {
    // 尝试初始化 Markdown 编辑器
    initMarkdownEditor();
    
    // 初始化富文本编辑器
    initRichTextEditor();
}

// 初始化 Markdown 编辑器
function initMarkdownEditor() {
    try {
        // 检查 editormd 是否可用
        if (typeof editormd === 'undefined') {
            console.warn('Editor.md 未加载，将使用简单文本框');
            $('#editormd').html('<textarea class="form-control" name="content" rows="20" placeholder="请输入 Markdown 内容...">' + $('#markdownContent').val() + '</textarea>');
            return;
        }
        
        editor = editormd("editormd", {
            width: "100%",
            height: 600,
            syncScrolling: "single",
            path: "https://cdn.jsdelivr.net/npm/editor.md@1.5.0/lib/",
            placeholder: "请输入教程内容，支持 Markdown 语法...",
            emoji: true,
            taskList: true,
            tex: false, // 禁用数学公式以提高兼容性
            flowChart: false,
            sequenceDiagram: false,
            toolbarIcons: [
                "undo", "redo", "|", 
                "bold", "del", "italic", "quote", "|", 
                "h1", "h2", "h3", "h4", "h5", "h6", "|",
                "list-ul", "list-ol", "hr", "|",
                "link", "image", "code", "code-block", "table", "|",
                "watch", "preview", "fullscreen", "clear", "search"
            ],
            lang: {
                name: "zh-cn",
                description: "Markdown编辑器"
            },
            onload: function() {
                console.log('Markdown Editor loaded successfully');
            },
            onchange: function() {
                // 自动保存内容
                syncEditorContent();
            }
        });
    } catch (error) {
        console.error('Markdown编辑器初始化失败:', error);
        // 降级到简单文本框
        $('#editormd').html('<textarea class="form-control" name="content" rows="20" placeholder="请输入 Markdown 内容...">' + $('#markdownContent').val() + '</textarea>');
    }
}

// 初始化富文本编辑器
function initRichTextEditor() {
    try {
        if (typeof Quill !== 'undefined') {
            quillEditor = new Quill('#quillEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'code-block'],
                        ['clean']
                    ]
                },
                placeholder: '请输入教程内容...'
            });
            
            // 设置初始内容
            const initialContent = $('#richtextContent').val();
            if (initialContent) {
                quillEditor.root.innerHTML = initialContent;
            }
            
            // 监听内容变化
            quillEditor.on('text-change', function() {
                syncEditorContent();
            });
            
            console.log('富文本编辑器初始化成功');
        }
    } catch (error) {
        console.error('富文本编辑器初始化失败:', error);
    }
}

// 设置 Markdown 文档导入
function setupMarkdownImport() {
    try {
        const importArea = $('#markdownImport');
        const fileInput = $('#markdownFile');
        
        if (importArea.length === 0 || fileInput.length === 0) {
            console.warn('Markdown导入元素未找到，跳过初始化');
            return;
        }
        
        // 点击导入
        importArea.on('click', function() {
            fileInput.click();
        });
        
        // 文件选择
        fileInput.on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                readMarkdownFile(file);
            }
        });
        
        // 拖拽导入
        importArea.on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });
        
        importArea.on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });
        
        importArea.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
            
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                readMarkdownFile(files[0]);
            }
        });
        
        console.log('Markdown导入功能初始化完成');
    } catch (error) {
        console.error('Markdown导入功能初始化失败:', error);
    }
}

// 读取 Markdown 文件
function readMarkdownFile(file) {
    if (!file.name.match(/\.(md|markdown|txt)$/i)) {
        showNotification('请选择 .md 或 .markdown 文件', 'warning');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            
            // 尝试解析标题和内容
            const lines = content.split('\n');
            let title = '';
            let summary = '';
            let bodyContent = content;
            
            // 查找第一个 # 标题作为教程标题
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('# ')) {
                    title = line.substring(2).trim();
                    // 移除标题行
                    lines.splice(i, 1);
                    bodyContent = lines.join('\n');
                    break;
                }
            }
            
            // 生成摘要（取前200个字符）
            const plainText = bodyContent.replace(/[#*`\[\]]/g, '').trim();
            summary = plainText.substring(0, 200) + (plainText.length > 200 ? '...' : '');
            
            // 填充表单
            if (title) {
                const titleInput = document.getElementById('title');
                if (titleInput) titleInput.value = title;
            }
            if (summary) {
                const summaryInput = document.getElementById('summary');
                if (summaryInput) {
                    summaryInput.value = summary;
                    // 触发输入事件更新计数器
                    const event = new Event('input', { bubbles: true });
                    summaryInput.dispatchEvent(event);
                }
            }
            
            // 设置编辑器内容
            if (currentEditorMode === 'markdown') {
                if (editor && editor.setMarkdown) {
                    editor.setMarkdown(bodyContent);
                } else {
                    // 降级处理
                    const textarea = document.querySelector('#editormd textarea, textarea[name="content"]');
                    if (textarea) textarea.value = bodyContent;
                }
            } else if (currentEditorMode === 'richtext' && quillEditor) {
                // 将Markdown转换为HTML（简单处理）
                const htmlContent = markdownToHtml(bodyContent);
                quillEditor.root.innerHTML = htmlContent;
            }
            
            // 提示
            showNotification('Markdown 文件导入成功', 'success');
        } catch (error) {
            console.error('文件读取失败:', error);
            showNotification('文件导入失败，请检查文件格式', 'danger');
        }
    };
    
    reader.onerror = function() {
        showNotification('文件读取失败', 'danger');
    };
    
    reader.readAsText(file);
}

// 简单的Markdown转HTML函数
function markdownToHtml(markdown) {
    return markdown
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
        .replace(/\*(.*)\*/gim, '<em>$1</em>')
        .replace(/^\* (.*$)/gim, '<li>$1</li>')
        .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
        .replace(/\n/g, '<br>');
}

// 插入模板
function insertTemplate(type) {
    let template = '';
    let richTemplate = '';
    
    switch(type) {
        case 'basic':
            template = `# 教程标题

## 简介

在这里介绍本教程的目标和适用场景。

## 前提条件

- 条件1
- 条件2
- 条件3

## 主要内容

### 第一部分

详细介绍第一部分内容...

### 第二部分

详细介绍第二部分内容...

## 总结

总结本教程的要点...

## 延伸阅读

- [相关链接1](https://example.com)
- [相关链接2](https://example.com)
`;
            richTemplate = `<h1>教程标题</h1>
<h2>简介</h2>
<p>在这里介绍本教程的目标和适用场景。</p>
<h2>前提条件</h2>
<ul>
<li>条件1</li>
<li>条件2</li>
<li>条件3</li>
</ul>
<h2>主要内容</h2>
<h3>第一部分</h3>
<p>详细介绍第一部分内容...</p>
<h3>第二部分</h3>
<p>详细介绍第二部分内容...</p>
<h2>总结</h2>
<p>总结本教程的要点...</p>
<h2>延伸阅读</h2>
<ul>
<li><a href="https://example.com">相关链接1</a></li>
<li><a href="https://example.com">相关链接2</a></li>
</ul>`;
            break;
            
        case 'steps':
            template = `# 操作教程

## 概述

本教程将指导您完成...

## 步骤详解

### 步骤1：准备工作

1. 首先...
2. 然后...
3. 接下来...

> **注意：** 重要提示信息

### 步骤2：核心操作

1. 打开...
2. 点击...
3. 输入...

\`\`\`bash
# 示例代码
command example
\`\`\`

### 步骤3：验证结果

1. 检查...
2. 确认...

## 常见问题

**Q: 如果遇到错误怎么办？**
A: 请检查...

**Q: 为什么没有效果？**
A: 可能的原因是...

## 完成

恭喜！您已经成功完成了...
`;
            richTemplate = `<h1>操作教程</h1>
<h2>概述</h2>
<p>本教程将指导您完成...</p>
<h2>步骤详解</h2>
<h3>步骤1：准备工作</h3>
<ol>
<li>首先...</li>
<li>然后...</li>
<li>接下来...</li>
</ol>
<blockquote><strong>注意：</strong> 重要提示信息</blockquote>
<h3>步骤2：核心操作</h3>
<ol>
<li>打开...</li>
<li>点击...</li>
<li>输入...</li>
</ol>
<pre><code># 示例代码
command example</code></pre>
<h3>步骤3：验证结果</h3>
<ol>
<li>检查...</li>
<li>确认...</li>
</ol>
<h2>常见问题</h2>
<p><strong>Q: 如果遇到错误怎么办？</strong><br>A: 请检查...</p>
<p><strong>Q: 为什么没有效果？</strong><br>A: 可能的原因是...</p>
<h2>完成</h2>
<p>恭喜！您已经成功完成了...</p>`;
            break;
            
        case 'faq':
            template = `# 常见问题解答

## 基础问题

### Q1: 这是什么？
**A:** 详细回答...

### Q2: 如何使用？
**A:** 使用方法如下：
1. 第一步
2. 第二步
3. 第三步

## 高级问题

### Q3: 如何解决复杂问题？
**A:** 解决方案：

- 方案1：...
- 方案2：...
- 方案3：...

### Q4: 有什么注意事项？
**A:** 需要注意：

> ⚠️ **重要提醒：** 在操作前请务必...

## 技术问题

### Q5: 如何排查错误？
**A:** 排查步骤：

\`\`\`
错误信息示例
\`\`\`

解决方法：...

## 联系支持

如果以上解答不能解决您的问题，请...
`;
            richTemplate = `<h1>常见问题解答</h1>
<h2>基础问题</h2>
<h3>Q1: 这是什么？</h3>
<p><strong>A:</strong> 详细回答...</p>
<h3>Q2: 如何使用？</h3>
<p><strong>A:</strong> 使用方法如下：</p>
<ol>
<li>第一步</li>
<li>第二步</li>
<li>第三步</li>
</ol>
<h2>高级问题</h2>
<h3>Q3: 如何解决复杂问题？</h3>
<p><strong>A:</strong> 解决方案：</p>
<ul>
<li>方案1：...</li>
<li>方案2：...</li>
<li>方案3：...</li>
</ul>
<h3>Q4: 有什么注意事项？</h3>
<p><strong>A:</strong> 需要注意：</p>
<blockquote>⚠️ <strong>重要提醒：</strong> 在操作前请务必...</blockquote>
<h2>技术问题</h2>
<h3>Q5: 如何排查错误？</h3>
<p><strong>A:</strong> 排查步骤：</p>
<pre><code>错误信息示例</code></pre>
<p>解决方法：...</p>
<h2>联系支持</h2>
<p>如果以上解答不能解决您的问题，请...</p>`;
            break;
    }
    
    if (currentEditorMode === 'markdown') {
        if (editor && editor.setMarkdown) {
            editor.setMarkdown(template);
        } else {
            $('#editormd textarea').val(template);
        }
    } else if (currentEditorMode === 'richtext' && quillEditor) {
        quillEditor.root.innerHTML = richTemplate;
    }
    
    $('#templateModal').modal('hide');
}

// 切换预览模式
function togglePreview() {
    if (isPreviewMode) {
        editor.watch();
        $('#togglePreview i').removeClass('fa-edit').addClass('fa-eye');
        isPreviewMode = false;
    } else {
        editor.unwatch();
        $('#togglePreview i').removeClass('fa-eye').addClass('fa-edit');
        isPreviewMode = true;
    }
}

// 保存草稿
function saveDraft() {
    $('#status').val('draft');
    $('#tutorialForm').submit();
}

// 编辑器模式切换
function switchEditorMode(mode) {
    currentEditorMode = mode;
    
    if (mode === 'markdown') {
        $('#editormd').show();
        $('#richtextEditor').hide();
        syncEditorContent();
    } else if (mode === 'richtext') {
        $('#editormd').hide();
        $('#richtextEditor').show();
        syncEditorContent();
    }
}

// 同步编辑器内容
function syncEditorContent() {
    try {
        if (currentEditorMode === 'markdown') {
            let content = '';
            if (editor && editor.getMarkdown) {
                content = editor.getMarkdown();
            } else {
                // 降级处理
                content = $('#editormd textarea[name="content"]').val() || '';
            }
            $('input[name="content"]').remove(); // 移除可能存在的input
            if ($('textarea[name="content"]').length === 0) {
                $('#tutorialForm').append('<textarea name="content" style="display:none;"></textarea>');
            }
            $('textarea[name="content"]').val(content);
        } else if (currentEditorMode === 'richtext' && quillEditor) {
            const content = quillEditor.root.innerHTML;
            $('#richtextContent').val(content);
            $('input[name="content"]').remove(); // 移除可能存在的input
            if ($('textarea[name="content"]').length === 0) {
                $('#tutorialForm').append('<textarea name="content" style="display:none;"></textarea>');
            }
            $('textarea[name="content"]').val(content);
        }
    } catch (error) {
        console.error('内容同步失败:', error);
    }
}

// 使用模板
function useTemplate(type) {
    let currentContent = '';
    
    if (currentEditorMode === 'markdown') {
        currentContent = editor && editor.getMarkdown ? editor.getMarkdown() : '';
    } else {
        currentContent = quillEditor ? quillEditor.root.innerHTML : '';
    }
    
    if (currentContent.trim() !== '') {
        if (!confirm('当前编辑器有内容，确定要替换为模板内容吗？')) {
            return;
        }
    }
    insertTemplate(type);
}
</script>

<!-- 自定义通知系统已集成 -->
{% endblock %}