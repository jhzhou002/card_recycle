<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}卡券回收平台{% endblock %}</title>
    {% load static %}
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/all.min.css' %}" rel="stylesheet">
    <style>
        /* 自定义样式 */
        body {
            background-color: #f8f9fa;
            font-size: 14px;
        }

        .jumbotron {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .navbar-brand {
            font-weight: bold;
        }

        .alerts-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            width: 300px;
        }

        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }

        .badge {
            font-size: 0.75em;
        }

        footer {
            margin-top: auto;
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            /* 导航栏优化 */
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .navbar-nav .nav-link {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            
            .navbar-collapse {
                margin-top: 0.5rem;
            }
            
            /* 移动端导航菜单样式 */
            .navbar-nav .nav-item:last-child .nav-link {
                border-bottom: none;
            }
            
            /* 主要内容区域 */
            .jumbotron {
                padding: 1.5rem 1rem;
                margin-bottom: 1rem;
            }
            
            .jumbotron h1 {
                font-size: 1.8rem;
            }
            
            .jumbotron .lead {
                font-size: 1rem;
            }
            
            /* 卡片布局 */
            .card-body {
                padding: 1rem;
            }
            
            .card-header h4,
            .card-header h5 {
                font-size: 1.1rem;
            }
            
            /* 表格优化 */
            .table-responsive {
                border: none;
            }
            
            .table td,
            .table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.9rem;
            }
            
            /* 按钮优化 */
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            
            /* 表单优化 */
            .form-control {
                font-size: 16px; /* 防止iOS缩放 */
            }
            
            .form-label {
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }
            
            /* 通知优化 */
            .alerts-container {
                width: 95%;
                right: 2.5%;
                top: 70px;
            }
            
            /* 分页优化 */
            .pagination {
                margin-bottom: 1rem;
            }
            
            .page-link {
                padding: 0.375rem 0.75rem;
                font-size: 0.9rem;
            }
            
            /* 状态徽章优化 */
            .badge {
                font-size: 0.7rem;
                padding: 0.25em 0.5em;
            }
            
            /* 图片优化 */
            img {
                max-width: 100%;
                height: auto;
            }
        }

        /* 小屏幕设备 */
        @media (max-width: 576px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .jumbotron h1 {
                font-size: 1.5rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .btn {
                font-size: 0.9rem;
                padding: 0.375rem 0.75rem;
            }
            
            .table td,
            .table th {
                padding: 0.375rem 0.25rem;
                font-size: 0.8rem;
            }
            
            /* 隐藏不重要的列 */
            .table .d-none-mobile {
                display: none !important;
            }
        }

        /* 平板设备 */
        @media (min-width: 768px) and (max-width: 1024px) {
            .card-columns {
                column-count: 2;
            }
        }

        /* 横屏手机 */
        @media (max-width: 768px) and (orientation: landscape) {
            .jumbotron {
                padding: 1rem;
            }
            
            .jumbotron h1 {
                font-size: 1.6rem;
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .btn,
            .nav-link,
            .page-link {
                min-height: 44px; /* 触摸目标最小尺寸 */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .table-responsive {
                -webkit-overflow-scrolling: touch;
            }
            
            /* 表单输入优化 */
            .form-control,
            .form-select {
                min-height: 44px;
                font-size: 16px; /* 防止iOS Safari缩放 */
            }
            
            /* 卡片点击区域优化 */
            .card {
                cursor: pointer;
            }
        }
        
        /* PWA支持 */
        .standalone-mode {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* 减少动画以提高性能 */
        @media (prefers-reduced-motion: reduce) {
            .card {
                transition: none;
            }
            
            .alert {
                animation: none;
            }
        }

        /* APP风格移动端底部导航栏 */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-top: 1px solid #e9ecef;
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: env(safe-area-inset-bottom) 0 0 0;
        }

        .bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 12px 12px;
            max-width: 100%;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #6c757d;
            font-size: 12px;
            font-weight: 500;
            padding: 8px 4px;
            border-radius: 12px;
            min-width: 60px;
            transition: all 0.2s ease;
        }

        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }

        .bottom-nav-item span {
            line-height: 1;
            transition: all 0.2s ease;
        }

        .bottom-nav-item:hover {
            color: #495057;
            text-decoration: none;
            transform: translateY(-1px);
        }

        .bottom-nav-item.active {
            color: #007bff;
            background: rgba(0, 123, 255, 0.08);
        }

        .bottom-nav-item.active i {
            color: #007bff;
            transform: scale(1.1);
        }

        .bottom-nav-item.disabled {
            color: #adb5bd;
            cursor: not-allowed;
        }

        .bottom-nav-item.disabled:hover {
            transform: none;
        }

        /* 为移动端主要内容区域留出底部导航空间 */
        @media (max-width: 768px) {
            .main-content {
                padding-bottom: 90px; /* 为底部导航留出空间 */
            }
            
            /* 隐藏移动端顶部导航的部分元素 */
            .navbar-nav .nav-item {
                display: none;
            }
            
            .navbar-nav .nav-item.dropdown {
                display: block;
            }
            
            /* 简化移动端顶部导航 */
            .navbar {
                padding: 0.5rem 1rem;
                background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            }
            
            .navbar-brand {
                font-size: 1rem;
                font-weight: 600;
            }
            
            /* 移动端footer调整 */
            footer {
                margin-bottom: 90px; /* 为底部导航留出空间 */
            }
        }

        /* APP风格的页面切换效果 */
        @media (max-width: 768px) {
            .main-content {
                animation: slideInUp 0.3s ease;
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0.8;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 底部导航的触摸反馈 */
        @media (hover: none) and (pointer: coarse) {
            .bottom-nav-item:active {
                transform: scale(0.95);
                background: rgba(0, 123, 255, 0.15);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <i class="fas fa-recycle"></i> 卡券回收平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">首页</a>
                    </li>
                    {% if user.is_authenticated and not user.is_staff %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'submit_bottle_cap' %}">瓶盖提交</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'submit_card' %}">提交卡券</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'my_submissions' %}">提交记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'tutorials' %}">卡券教程</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'profile' %}">个人中心</a>
                    </li>
                    {% endif %}
                    {% if user.is_staff %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'admin_dashboard' %}">
                            <i class="fas fa-crown"></i> 管理后台
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> {{ user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>退出登录
                            </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">登录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'register' %}">注册</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- 移动端APP风格主要内容区域 -->
    <main class="main-content">
        <div class="container mt-4">
            {% if messages %}
            <div class="alerts-container">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% block content %}
            {% endblock %}
        </div>
    </main>

    <!-- 移动端底部导航栏 -->
    <nav class="mobile-bottom-nav d-md-none">
        <div class="bottom-nav-container">
            <a href="{% url 'home' %}" class="bottom-nav-item {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </a>
            {% if user.is_authenticated and not user.is_staff %}
            <div class="bottom-nav-item disabled">
                <i class="fas fa-bullhorn text-muted"></i>
                <span class="text-muted">公告</span>
            </div>
            <div class="bottom-nav-item disabled">
                <i class="fas fa-chart-bar text-muted"></i>
                <span class="text-muted">统计</span>
            </div>
            <a href="{% url 'my_submissions' %}" class="bottom-nav-item {% if request.resolver_match.url_name == 'my_submissions' %}active{% endif %}">
                <i class="fas fa-list-alt"></i>
                <span>订单</span>
            </a>
            <a href="{% url 'profile' %}" class="bottom-nav-item {% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
                <i class="fas fa-user"></i>
                <span>我的</span>
            </a>
            {% else %}
            <a href="{% url 'login' %}" class="bottom-nav-item {% if request.resolver_match.url_name == 'login' %}active{% endif %}">
                <i class="fas fa-sign-in-alt"></i>
                <span>登录</span>
            </a>
            <a href="{% url 'register' %}" class="bottom-nav-item {% if request.resolver_match.url_name == 'register' %}active{% endif %}">
                <i class="fas fa-user-plus"></i>
                <span>注册</span>
            </a>
            <div class="bottom-nav-item disabled">
                <i class="fas fa-lock text-muted"></i>
                <span class="text-muted">敬请期待</span>
            </div>
            <div class="bottom-nav-item disabled">
                <i class="fas fa-ellipsis-h text-muted"></i>
                <span class="text-muted">更多</span>
            </div>
            {% endif %}
        </div>
    </nav>

    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p>&copy; 2024 卡券回收平台. All rights reserved.</p>
        </div>
    </footer>

    <!-- 优先使用CDN jQuery，确保快速加载 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" 
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" 
            crossorigin="anonymous"></script>
    <script>
    // 检测jQuery是否加载成功，失败则使用本地备用
    if (typeof $ === 'undefined') {
        console.log('CDN jQuery加载失败，使用本地备用');
        var localScript = document.createElement('script');
        localScript.src = '{% static "js/jquery-3.6.0.min.js" %}';
        localScript.onload = function() {
            console.log('本地jQuery加载成功，版本：' + $.fn.jquery);
        };
        localScript.onerror = function() {
            console.error('本地jQuery也加载失败');
        };
        document.head.appendChild(localScript);
    } else {
        console.log('CDN jQuery加载成功，版本：' + $.fn.jquery);
    }
    </script>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    
    <!-- 移动端特有交互优化脚本 -->
    <script>
    // 检测移动设备
    function isMobileDevice() {
        return window.matchMedia('(max-width: 768px)').matches || 
               /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // 移动端优化功能 - 只在移动设备上激活
    if (isMobileDevice()) {
        $(document).ready(function() {
            // 1. 优化表单输入焦点管理
            $('input, textarea, select').on('focus', function() {
                // 滚动到输入框位置，避免被虚拟键盘遮挡
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
            
            // 2. 添加触摸反馈动画 - 仅移动设备
            $('.btn, .card, .nav-link, .dropdown-item').on('touchstart', function() {
                $(this).addClass('mobile-touch-active');
            }).on('touchend touchcancel', function() {
                $(this).removeClass('mobile-touch-active');
            });
            
            // 3. 优化长按菜单（防止意外触发）
            $('img, .card').on('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // 4. 滑动返回顶部功能
            let isScrolling = false;
            let scrollTimeout;
            
            $(window).on('scroll', function() {
                if (!isScrolling) {
                    isScrolling = true;
                    // 显示返回顶部按钮
                    if ($(window).scrollTop() > 300) {
                        showBackToTop();
                    } else {
                        hideBackToTop();
                    }
                }
                
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    isScrolling = false;
                }, 100);
            });
            
            // 5. 双击缩放防护
            $('body').on('touchstart', function(e) {
                if (e.touches && e.touches.length > 1) {
                    e.preventDefault();
                }
            });
            
            let lastTouchEnd = 0;
            $('body').on('touchend', function(e) {
                let now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            });
            
            // 6. 网络状态提示
            if ('navigator' in window && 'onLine' in navigator) {
                $(window).on('online', function() {
                    showNetworkStatus('网络已连接', 'success');
                }).on('offline', function() {
                    showNetworkStatus('网络连接中断', 'warning');
                });
            }
        });
    }
    
    // 返回顶部按钮功能
    function showBackToTop() {
        if ($('#backToTopBtn').length === 0) {
            $('body').append(`
                <button id="backToTopBtn" class="btn btn-primary position-fixed" 
                        style="bottom: 20px; right: 20px; z-index: 1000; border-radius: 50%; 
                               width: 50px; height: 50px; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                    <i class="fas fa-chevron-up"></i>
                </button>
            `);
            
            $('#backToTopBtn').on('click', function() {
                $('html, body').animate({ scrollTop: 0 }, 500);
            });
        }
        $('#backToTopBtn').fadeIn(200);
    }
    
    function hideBackToTop() {
        $('#backToTopBtn').fadeOut(200);
    }
    
    // 网络状态提示
    function showNetworkStatus(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-warning';
        const toast = $(`
            <div class="alert ${alertClass} position-fixed top-0 start-50 translate-middle-x mt-3" 
                 style="z-index: 9999; min-width: 250px; text-align: center;">
                <i class="fas fa-${type === 'success' ? 'wifi' : 'exclamation-triangle'} me-2"></i>
                ${message}
            </div>
        `);
        
        $('body').append(toast);
        
        setTimeout(() => {
            toast.fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }
    
    // 添加移动端触摸反馈CSS
    $('<style>')
        .prop('type', 'text/css')
        .html(`
            .mobile-touch-active {
                opacity: 0.7 !important;
                transform: scale(0.98) !important;
                transition: all 0.1s ease !important;
            }
            
            /* 防止iOS双击缩放 */
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            /* 允许输入框和文本选择 */
            input, textarea, [contenteditable] {
                -webkit-user-select: text !important;
                -khtml-user-select: text !important;
                -moz-user-select: text !important;
                -ms-user-select: text !important;
                user-select: text !important;
            }
            
            /* 滚动条优化 */
            ::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }
            
            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 2px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
        `)
        .appendTo('head');
    </script>
    
    {% block extra_js %}
    {% endblock %}
</body>
</html>